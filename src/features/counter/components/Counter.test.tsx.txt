import { fireEvent, screen } from '@testing-library/react'; // ğŸ’¡ FIX: screenã¨fireEventã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { describe, expect, it, vi } from 'vitest'; // ğŸ’¡ FIX: vitestã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

import { renderWithContext } from '../../../test/utils';
import { CounterContext } from '../context/CounterContext';
import { createMockCounterContextValue } from '../test/mocks/useCounterStorageMock';
import { Counter } from './Counter';

// ------------------------------------
// ğŸ§ª ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
// ------------------------------------
describe('Counter Component (Vitest Mock)', () => {
  // åˆæœŸå€¤ 0 ã®ãƒ†ã‚¹ãƒˆ
  it('åˆæœŸå€¤ãŒContextã‹ã‚‰å–å¾—ã•ã‚ŒãŸå€¤ï¼ˆ5ï¼‰ã§è¡¨ç¤ºã•ã‚Œã‚‹ã¹ã', () => {
    // ä¾å­˜ãƒ•ãƒƒã‚¯ãŒè¿”ã™çŠ¶æ…‹
    const initialCount = 5;
    const setCountMock = vi.fn();
    const mockContextValue = createMockCounterContextValue(initialCount, setCountMock);

    renderWithContext(<Counter />, CounterContext, mockContextValue);

    // åˆæœŸå€¤ 5 ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    // ğŸ’¡ screen.getByText ã‚’ä½¿ç”¨
    expect(screen.getByText('5')).toBeInTheDocument();
  });

  // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—å‡¦ç†ã®ãƒ†ã‚¹ãƒˆ
  it('ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€setCountãŒæ­£ã—ã„ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆé‡ï¼ˆ1ï¼‰ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã¹ã', () => {
    const initialCount = 5;
    // ğŸ’¡ setCountMockã‚’vi.fn()ã¨ã—ã¦å®šç¾©ã—ã€å‘¼ã³å‡ºã—ã‚’è¿½è·¡
    const setCountMock = vi.fn();
    const mockContextValue = createMockCounterContextValue(initialCount, setCountMock);

    renderWithContext(<Counter />, CounterContext, mockContextValue);

    // åˆæœŸå€¤ 5 ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(screen.getByText('5')).toBeInTheDocument();

    // ğŸ’¡ screen.getByRole ã‚’ä½¿ç”¨ã—ã¦ãƒœã‚¿ãƒ³ã‚’å–å¾—
    const button = screen.getByRole('button', { name: /ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ä¿å­˜/i });
    fireEvent.click(button);

    // Counter.tsxã®å®šç¾©ã«åŸºã¥ãã€ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆé‡ 1 ãŒæ¸¡ã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
    expect(setCountMock).toHaveBeenCalledWith(1);
    expect(setCountMock).toHaveBeenCalledTimes(1);

    // UIã¯ãƒ¢ãƒƒã‚¯ã®æˆ»ã‚Šå€¤ãŒå¤‰ã‚ã‚‰ãªã„ãŸã‚ã€5ã®ã¾ã¾ã®ã¯ãš
    expect(screen.getByText('5')).toBeInTheDocument();
  });
});
